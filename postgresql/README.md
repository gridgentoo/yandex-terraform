# Работа с сервисом Managed Service for PostgreSQL

* Зайдите в консоль Яндекс.Облака https://console.cloud.yandex.ru
* Cоздайте себе каталог, выбрав опцию создания сети по умолчанию
* Зайдите в созданный каталог

### Создайте кластер PostgreSQL

* Перейдите на главную страницу сервиса Managed Service for PostgreSQL
* Создайте кластер PostgreSQL со следующими параметрами:
- Класс хоста - s2.micro
- Хосты - добавьте 1 или два хоста в разных зонах доступности (чтобы суммарно было не менее двух хостов) и укажите необходимость публичного доступа (публичного IP адреса) для них
- Имя пользователя - test
- Пароль - test123456

Остальные параметры оставьте по умолчанию, либо измените по своему усмотрению.

* Нажмите кнопку Создать кластер и дождитесь окончания процесса создания (Статус кластера = RUNNING). Кластер создается от 5 до 10 минут
* Обратите внимание на калькулятор стоимости услуги и изменение стоимости при изменении параметров кластера.

### Подключитесь к кластеру

* Используйте инструкцию по подключению к кластеру, доступную на вкладке Обзор: cкачайте SSL сертификат и подключитесь к кластеру с помощью утилиты psql, указав hostname всех узлов и атрибут ```target_session_attrs=read-write```

* Проверьте, что подключение прошло к master-узлу.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
* Посмотрите количество подключенных реплик
```
select count(*) from pg_stat_replication;
```

### Проверьте работоспособность репликации в кластере

* Создайте таблицу и вставьте одну-две строки.
```
CREATE TABLE test_table(text varchar);
```
```
insert into test_table values('Строка 1');
```

* Выйдите из psql командой ```\q```.

* Теперь подключитесь к узлу-реплике. Для этого из команды подключения удалите атрибут ```target_session_attrs``` и в параметре атрибут ```host``` передайте только имя хоста-реплики. Роли хостов можно посмотреть на соответствующей вкладке UI консоли.

* Проверьте, что подключение прошло к узлу-реплике.
```
select case when pg_is_in_recovery() then 'REPLICA' else 'MASTER' end;
```
* Проверьте состояние репликации
```
select status from pg_stat_wal_receiver;
```

* Для проверки, что механизм репликации данных работает между зонами доступности облака, выполните запрос к таблице, созданной на предыдущем шаге:
```
select * from test_table;
```

### Удалите кластер

* Удалите кластер выбрав соответствующее действие в UI консоли.
* Обратите внимание, что данные удаляемого кластера можно восстановить в течении 7 дней после удаления, т.к. в течении этого периода сохраняются его резервные копии.
